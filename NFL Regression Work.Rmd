---
title: "NFL Regression"
author: "Jerome Roehm"
date: "`r Sys.Date()`"
output:
  html_document: default
---

# NFL Regression

```{r, include=FALSE}
knitr::opts_chunk$set(message=FALSE)
library(tidyverse)
library(stats)
library(PropCIs)
library(binom)
library(ggnewscale)
library(plotly)
library(gapminder)
library(nflfastR)
library(Metrics)
library(igraph)
library(dplyr)
```


##Import data from NFLverse

Updated frequently, for play by play data, consider NFLfastR?

```{r}
games <- read.csv('https://raw.githubusercontent.com/nflverse/nfldata/refs/heads/master/data/games.csv')
games <- filter(games,season > 2002) #errors in NFLfastR end in 2002 (it seems)

#current team names (how NFLfastR does it...)
games$away_team[games$away_team=='STL'] <- 'LA'
games$away_team[games$away_team=='SD'] <- 'LAC'
games$away_team[games$away_team=='OAK'] <- 'LV'
games$home_team[games$home_team=='STL'] <- 'LA'
games$home_team[games$home_team=='SD'] <- 'LAC'
games$home_team[games$home_team=='OAK'] <- 'LV'

games
```

## Create giant datafrome

Compute season wins, losses, ties, winning percentages and add to `games` dataframe

Takes a few minutes to run

```{r}
games<- games %>% mutate(winner_ha = case_when(result>0 ~ 'home', 
                                              result<0 ~ 'away',
                                              TRUE ~ 'tie')) %>% 
  mutate(winner_team = case_when(result>0 ~ home_team, 
                                 result<0 ~ away_team,
                                 TRUE ~ 'tie')) %>% 
  mutate(loser_team = case_when(result<0 ~ home_team, 
                                 result>0 ~ away_team,
                                 TRUE ~ 'tie'))

home_incoming_wins <- c(0)
home_incoming_losses <- c(0)
away_incoming_wins <- c(0)
away_incoming_losses <- c(0)
home_incoming_ties <- c(0)
away_incoming_ties <- c(0)

home_incoming_points_scored <- c(0)
home_incoming_points_allowed <- c(0)
away_incoming_points_scored <- c(0)
away_incoming_points_allowed <- c(0)

for (i in 2:nrow(games)) {
  home_incoming_wins[i] <- nrow(filter(games[1:(i-1),],winner_team==games[i,]$home_team,
                                       season==games[i,]$season))
  home_incoming_losses[i] <- nrow(filter(games[1:(i-1),],loser_team==games[i,]$home_team,
                                       season==games[i,]$season))
  away_incoming_wins[i] <- nrow(filter(games[1:(i-1),],winner_team==games[i,]$away_team,
                                       season==games[i,]$season))
  away_incoming_losses[i] <- nrow(filter(games[1:(i-1),],loser_team==games[i,]$away_team,
                                       season==games[i,]$season))
  home_incoming_ties[i] <- nrow(filter(games[1:(i-1),],winner_team=='tie',home_team==games[i,]$home_team,
                                       season==games[i,]$season)) +
                           nrow(filter(games[1:(i-1),],winner_team=='tie',away_team==games[i,]$home_team,
                                       season==games[i,]$season))
  away_incoming_ties[i] <- nrow(filter(games[1:(i-1),],winner_team=='tie',home_team==games[i,]$away_team,
                                       season==games[i,]$season)) +
                           nrow(filter(games[1:(i-1),],winner_team=='tie',away_team==games[i,]$away_team,
                                       season==games[i,]$season))
  home_incoming_points_scored[i] <- sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               home_team==games[i,]$home_team)$home_score) +
                                    sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               away_team==games[i,]$home_team)$away_score)
  away_incoming_points_scored[i] <- sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               home_team==games[i,]$away_team)$home_score) +
                                    sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               away_team==games[i,]$away_team)$away_score)
  home_incoming_points_allowed[i] <- sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               home_team==games[i,]$home_team)$away_score) +
                                    sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               away_team==games[i,]$home_team)$home_score)
  away_incoming_points_allowed[i] <- sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               home_team==games[i,]$away_team)$away_score) +
                                    sum(filter(games[1:(i-1),],
                                               season==games[i,]$season,
                                               away_team==games[i,]$away_team)$home_score)
}

games$home_incoming_wins <- home_incoming_wins
games$home_incoming_losses <- home_incoming_losses
games$home_incoming_ties <- home_incoming_ties
games$home_incoming_points_scored <- home_incoming_points_scored
games$home_incoming_points_allowed <- home_incoming_points_allowed
games$away_incoming_wins <- away_incoming_wins
games$away_incoming_losses <- away_incoming_losses
games$away_incoming_ties <- away_incoming_ties
games$away_incoming_points_scored <- away_incoming_points_scored
games$away_incoming_points_allowed <- away_incoming_points_allowed
```

```{r}
#adding more variables
games <- games %>% 
  mutate(rest_diff = home_rest - away_rest) %>% 
  mutate(home_incoming_games = home_incoming_wins+home_incoming_losses+home_incoming_ties,
         away_incoming_games = away_incoming_wins+away_incoming_losses+away_incoming_ties) %>% 
  mutate(home_incoming_win_perc = ifelse(home_incoming_games==0, 0, home_incoming_wins / home_incoming_games),
         away_incoming_win_perc = ifelse(away_incoming_games==0, 0, away_incoming_wins / away_incoming_games)) %>% 
  mutate(win_perc_diff = home_incoming_win_perc-away_incoming_win_perc) %>% 
  mutate(winner_01 = winner_ha=='home') %>% 
  mutate(home_incoming_point_diff = home_incoming_points_scored - home_incoming_points_allowed,
         away_incoming_point_diff = away_incoming_points_scored - away_incoming_points_allowed) %>% 
  mutate(point_diff_diff = home_incoming_point_diff - away_incoming_point_diff) %>% 
  mutate(wins_diff = home_incoming_wins - away_incoming_wins) %>% 
  mutate(home_moneyline_prob = ifelse(home_moneyline>0,100/(home_moneyline+100),abs(home_moneyline)/(abs(home_moneyline)+100))) %>% 
  mutate(away_moneyline_prob = ifelse(away_moneyline>0,100/(away_moneyline+100),abs(away_moneyline)/(abs(away_moneyline)+100))) %>% 
  mutate(home_moneyline_prob_a = 1-away_moneyline_prob) %>% 
  mutate(mean_moneyline_prob = (home_moneyline_prob+home_moneyline_prob_a)/2)
```

#### adding more variables with NFLfastR
```{r}
#takes a few minutes to run, 4 minutes and 31 seconds to be exact
all_fastR_team_stats <- calculate_stats(
  seasons = TRUE,
  summary_level = 'week',
  stat_type = 'team',
  season_type = "REG+POST"
)
```

```{r}
#yards per play
get_incoming_ypp <- function(season_num,
                             week_num,
                             team_name){
  prior_games <- all_fastR_team_stats %>% filter(team==team_name,season==season_num,week<week_num)
  prior_games <- mutate(prior_games,
                  plays = attempts + sacks_suffered + carries,
                  tot_yards = passing_yards + rushing_yards + sack_yards_lost)
  if(sum(prior_games$plays)>0){
    return(sum(prior_games$tot_yards)/sum(prior_games$plays))
  }
  return(5)
}

get_incoming_ypp_a <- function(season_num,
                               week_num,
                               team_name){
  prior_games <- all_fastR_team_stats %>% filter(opponent_team==team_name,season==season_num,week<week_num)
  prior_games <- mutate(prior_games,
                  plays = attempts + sacks_suffered + carries,
                  tot_yards = passing_yards + rushing_yards + sack_yards_lost)
  if(sum(prior_games$plays)>0){
    return(sum(prior_games$tot_yards)/sum(prior_games$plays))
  }
  return(5)
}

home_ypp <- c()
home_ypp_a <- c()
away_ypp <- c()
away_ypp_a <- c()

for (i in 1:nrow(games)) {
  home_ypp[i] <- get_incoming_ypp(games[i,]$season,
                             games[i,]$week,
                             games[i,]$home_team)
  home_ypp_a[i] <- get_incoming_ypp_a(games[i,]$season,
                                 games[i,]$week,
                                 games[i,]$home_team)
  away_ypp[i] <- get_incoming_ypp(games[i,]$season,
                             games[i,]$week,
                             games[i,]$away_team)
  away_ypp_a[i] <- get_incoming_ypp_a(games[i,]$season,
                                 games[i,]$week,
                                 games[i,]$away_team)
}
games$home_incoming_ypp <- home_ypp
games$home_incoming_ypp_a <- home_ypp_a
games$away_incoming_ypp <- away_ypp
games$away_incoming_ypp_a <- away_ypp_a

games <- games %>% 
  mutate(home_incoming_ypp_diff = home_ypp - home_ypp_a) %>% 
  mutate(away_incoming_ypp_diff = away_ypp - away_ypp_a) %>%
  mutate(ypp_diff_diff = home_incoming_ypp_diff - away_incoming_ypp_diff)


#turnovers, created, given up, then difference, then difference differential

get_turnovers_forced <- function(season_num,
                             week_num,
                             team_name){
  prior_games <- all_fastR_team_stats %>% filter(team==team_name,season==season_num,week<week_num)
  prior_games <- mutate(prior_games,
                  turnovers_forced = fumble_recovery_opp + def_interceptions)
  return(sum(prior_games$turnovers_forced))
}

get_turnovers_lost <- function(season_num,
                               week_num,
                               team_name){
  prior_games <- all_fastR_team_stats %>% filter(opponent_team==team_name,season==season_num,week<week_num)
  prior_games <- mutate(prior_games,
                  turnovers_lost = fumble_recovery_opp + def_interceptions)
  return(sum(prior_games$turnovers_lost))
}

home_turnovers_forced <- c()
home_turnovers_lost <- c()
away_turnovers_forced <- c()
away_turnovers_lost <- c()

for (i in 1:nrow(games)) {
  home_turnovers_forced[i] <- get_turnovers_forced(games[i,]$season,
                             games[i,]$week,
                             games[i,]$home_team)
  home_turnovers_lost[i] <- get_turnovers_lost(games[i,]$season,
                                 games[i,]$week,
                                 games[i,]$home_team)
  away_turnovers_forced[i] <- get_turnovers_forced(games[i,]$season,
                             games[i,]$week,
                             games[i,]$away_team)
  away_turnovers_lost[i] <- get_turnovers_lost(games[i,]$season,
                                 games[i,]$week,
                                 games[i,]$away_team)
}
games$home_turnovers_forced <- home_turnovers_forced
games$home_turnovers_lost <- home_turnovers_lost
games$away_turnovers_forced <- away_turnovers_forced
games$away_turnovers_lost <- away_turnovers_lost

games <- games %>% 
  mutate(home_turnovers_diff = home_turnovers_forced - home_turnovers_lost) %>% 
  mutate(away_turnovers_diff = away_turnovers_forced - away_turnovers_lost) %>%
  mutate(turnovers_diff_diff = home_turnovers_diff - away_turnovers_diff)
```

## Plotting variable distributions

```{r}
no_ties <- filter(games,winner_ha != 'tie')
wd_sum <- games %>%
  group_by(winner_ha,wins_diff) %>% 
  summarize(count = n()) %>% 
  mutate(prop = count/sum(count))

sp_sum <- games %>%
  group_by(winner_ha,spread_line) %>% 
  summarize(count = n()) %>% 
  mutate(prop = count/sum(count))

sp_sum2 <- games %>%
  group_by(spread_line,winner_ha) %>% 
  summarize(count = n()) %>% 
  mutate(prop = count/sum(count))

wd_sum2 <- games %>%
  group_by(wins_diff,winner_ha) %>% 
  summarize(count = n()) %>% 
  mutate(prop = count/sum(count))

ggplot(wd_sum2,aes(x=wins_diff,y=prop, color=winner_ha))+geom_line() + geom_point(aes(size=count))+
  labs(title='Outcomes by Win Difference')
ggplot(sp_sum2,aes(x=spread_line, y=prop, color=winner_ha))+geom_line() + geom_point(aes(size=count))+
  labs(title='Outcomes by Spread')


ggplot(wd_sum, aes(x = wins_diff, y=prop, color=winner_ha)) + geom_line() + geom_point(aes(size=count))+
  labs(title='Density (mass) plot by Win Difference')
ggplot(games, aes(x = point_diff_diff, color=winner_ha)) + geom_density()+
  labs(title='Density Plot of Point Differential Difference')
ggplot(games, aes(x = spread_line, color=winner_ha)) + geom_density()+
  labs(title='Density Plot of Spread')
ggplot(games, aes(x = mean_moneyline_prob, color=winner_ha)) + geom_density()+
  labs(title='Density Plot of Moneyline (implied probability)')
```
```{r}
#curiosity
select(filter(games, wins_diff>9),game_id,away_score,home_score)
```


## Visualizing simple regression models

```{r}
games_sum_wd <- games %>%
  group_by(wins_diff) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_wd, aes(x=wins_diff,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_wd,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Win Difference', y='Home Win Prob')

games_sum_wpd <- games %>%
  group_by(win_perc_diff) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_wpd, aes(x=win_perc_diff,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_wpd,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Win Percent Difference', y='Home Win Prob')

games_sum_pdd <- games %>%
  group_by(point_diff_diff) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_pdd, aes(x=point_diff_diff,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_pdd,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Point Differential Difference', y='Home Win Prob')

games_sum_sp <- games %>%
  group_by(spread_line) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_sp, aes(x=spread_line,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_sp,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Spread', y='Home Win Prob')



games_sum_ml <- games %>%
  group_by(home_moneyline_prob) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_ml, aes(x=home_moneyline_prob,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_ml,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Moneyline (prob)', y='Home Win Prob')+
  scale_size(range = c(1, 5),
             breaks = c(10, 30))



games_sum_yppdd <- games %>%
  group_by(round(ypp_diff_diff,1)) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_yppdd, aes(x=`round(ypp_diff_diff, 1)`,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_yppdd,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home Winning by Yards per Play Differential Difference', y='Home Win Prob')

games_sum_wd_d <- games %>%
  group_by(wins_diff, div_game) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(games_sum_wd_d, aes(x=wins_diff,y=home_win_perc,weight=count, color=as.factor(div_game))) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = games_sum_wd_d,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Wins Diff and Divisional Game', y='Home Win Prob')

```

```{r}
#models and plots for last5 wins home and away
final_games_sum_last5win_home <- final_games %>%
  group_by(last5_home_wins) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5win_home, aes(x=last5_home_wins,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5win_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Home Wins', y='Home Win Prob')

final_games_sum_last5win_away <- final_games %>%
  group_by(last5_away_wins) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5win_away, aes(x=last5_away_wins,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5win_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Away Wins', y='Home Win Prob')

#models and plots for last5 points scored home and away
last5_away_pointsscored <- c()

final_games_sum_last5ps_home <- final_games %>%
  group_by(last5_home_pointsscored) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5ps_home, aes(x=last5_home_pointsscored,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5ps_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Games Points Scored', y='Home Win Prob')

final_games_sum_last5ps_away <- final_games %>%
  group_by(last5_away_pointsscored) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5ps_away, aes(x=last5_away_pointsscored,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5ps_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Points Scored from Away', y='Home Win Prob')

#models and plots for last5 points allowed home and away
final_games_sum_last5pa_home <- final_games %>%
  group_by(last5_home_pointsallowed) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5pa_home, aes(x=last5_home_pointsallowed,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5pa_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Games Points Allowed from Home', y='Home Win Prob')

final_games_sum_last5pa_away <- final_games %>%
  group_by(last5_away_pointsallowed) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5pa_away, aes(x=last5_away_pointsallowed,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5pa_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Points Scored from Away', y='Home Win Prob')

#models and plots for last5 yards per play home and away
final_games_sum_last5ypp_home <- final_games %>%
  group_by(last5_home_incoming_ypp) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5ypp_home, aes(x=last5_home_incoming_ypp,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5ypp_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Home Incoming Yards per Play', y='Home Win Prob')

final_games_sum_last5ypp_away <- final_games %>%
  group_by(last5_away_incoming_ypp) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5ypp_away, aes(x=last5_away_incoming_ypp,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5ypp_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Away Incoming Yards per Play', y='Home Win Prob')

#models and plots for last5 yards per play against home and away
final_games_sum_last5yppa_home <- final_games %>%
  group_by(last5_home_incoming_ypp_a) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5yppa_home, aes(x=last5_home_incoming_ypp_a,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5yppa_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Games Yards Per Play Against for Home', y='Home Win Prob')

final_games_sum_last5yppa_away <- final_games %>%
  group_by(last5_away_incoming_ypp_a) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last5yppa_away, aes(x=last5_away_incoming_ypp_a,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last5yppa_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 5 Games Yards Per Play Against from Away', y='Home Win Prob')
#models and plots for last10 wins home and away
final_games_sum_last10win_home <- final_games %>%
  group_by(last10_wins_home) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last10win_home, aes(x=last10_wins_home,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last10win_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 10 Home Wins', y='Home Win Prob')

final_games_sum_last10win_away <- final_games %>%
  group_by(last10_wins_away) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last10win_away, aes(x=last10_wins_away,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last10win_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 10 Away Wins', y='Home Win Prob')

#models and plots for last10 PageRank home and away
final_games_sum_last10pr_home <- final_games %>%
  group_by(last10_home_pagerank) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last10pr_home, aes(x=last10_home_pagerank,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last10pr_home,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 10 Home PageRank', y='Home Win Prob')

final_games_sum_last10pr_away <- final_games %>%
  group_by(last10_away_pagerank) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_last10pr_away, aes(x=last10_away_pagerank,y=home_win_perc,weight=count)) +
  geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_last10pr_away,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=FALSE) +
  labs(title = 'Logistic Model for Home Winning by Last 10 Away PageRank', y='Home Win Prob')
```


```{r}
#problems with NFLfastR
get_incoming_ypp(1999,
                 2,
                'BAL')

filter(all_fastR_team_stats,opponent_team=='LA', team=='STL')

for(seasoni in 1999:2023){
  for(weeki in 1:22){
    if(nrow(filter(all_fastR_team_stats,season==seasoni,week==weeki))/2 != nrow(filter(games,season==seasoni,week==weeki))){
      print( c(seasoni, weeki, nrow(filter(all_fastR_team_stats,season==seasoni,week==weeki))/2, nrow(filter(games,season==seasoni,week==weeki))))
    }
    }
}

```

```{r}
mod_wpd <- glm(winner_01 ~ win_perc_diff, family = binomial, data=games)

densityplot(mod_wpd$fitted.values)
mean((mod_wpd$fitted.values>.5)==games$winner_01)
mean(games$winner_01)

mod_wpd_week <- glm(winner_01 ~ (win_perc_diff+week)^2, family = binomial, data=games)
mean((mod_wpd_week$fitted.values>.5)==games$winner_01)
```

## Testing and comparing models

```{r}

games_c <- filter(games,home_score>-1) #completed games

games_sc <- data.frame(scale(select_if(games_c, is.numeric))) #scaled for mean 0 and sd 1
games_sc$winner_01 <- as.numeric(games_c$winner_01)
```

```{r}
#for comparing models
test_models <- function(models,data,actual,name_list,custom=c(),custom_names=c()){
  standings <- data.frame()
  for(model in models){
    preds <- predict(model,data, type="response")
    LL <- logLoss(actual,preds)
    pc <- 1-mean(abs((preds>0.5)-actual))
    profit <- compute_profitability(data$winner_01,data$home_moneyline,data$away_moneyline,preds)
    
    results <- data.frame(LogLoss=LL,
                          Perc.correct=pc,
                          profit=profit)
    standings <- rbind(standings, results)
  }
  all_names_list <- name_list
  if(length(custom) > 0){
    for(i in 1:length(custom)){
      preds <- custom[,i]
      LL <- logLoss(actual,preds)
      pc <- 1-mean(abs((preds>0.5)-actual))
      profit <- compute_profitability(data$winner_01,data$home_moneyline,data$away_moneyline,preds)
      
      results <- data.frame(LogLoss=LL,
                          Perc.correct=pc,
                          profit=profit)
      standings <- rbind(standings, results)
      all_names_list <- append(all_names_list,custom_names[i])
    }
  }
  standings$names=all_names_list
  print(arrange(standings,LogLoss))
  print(arrange(standings,desc(Perc.correct)))
  print(arrange(standings,desc(profit)))
}
```

```{r}
games_ml <- filter(games,
                   mean_moneyline_prob>0) #games that have ml data

#one variable models
mod_pdd <- glm(winner_01 ~ point_diff_diff, family = binomial, data=games_ml)
mod_wd <- glm(winner_01 ~ wins_diff, family = binomial, data=games_ml)
mod_wpd <- glm(winner_01 ~ win_perc_diff, family = binomial, data=games_ml)
mod_yppdd <- glm(winner_01 ~ ypp_diff_diff, family = binomial, data=games_ml)

mod_sp <- glm(winner_01 ~ spread_line, family = binomial, data=games_ml)
mod_3 <- glm(winner_01 ~ (ypp_diff_diff+point_diff_diff+wins_diff)^3, family = binomial, data=games_ml)

mod_pr <- glm(winner_01 ~ pagerank_diff, family = binomial, data = games_ml)

test_models(mget(c('mod_pdd','mod_wd','mod_wpd','mod_yppdd','mod_sp','mod_3', 'mod_pr')),games_ml,games_ml$winner_01,
            c('point_diff_diff','wins_diff','win_perc_diff','ypp_diff_diff','spread_line_model','inter_3_model', 'PageRank_Model'),
            custom=data.frame(constant=list(rep(mean(games_ml$winner_01),length(games_ml$winner_01))),
                              moneyline=games_ml$mean_moneyline_prob),
            custom_names=c('constant','moneyline'))
```

## Comparing over time

```{r}
get_preds_df <- function(training_years=4,
                         testing_year=2024,
                         stop_training='year'){
  if(stop_training=='never'){
    train_data <- filter(games_ml,season %in% (testing_year-training_years):testing_year)
    test_data <- filter(games_ml,season==testing_year)
  }
  if(stop_training=='year'){
    train_data <- filter(games_ml,season %in% (testing_year-training_years):(testing_year-1))
    test_data <- filter(games_ml,season==testing_year)
  }
  #if(stop_training=='week'){
  #  train_data <- filter(games_ml,
  #                       season %in% (testing_year-training_years):(testing_year-1) | 
  #                         (season == testing_year & week < curr_week)) #shit... will need to retrain models each week, lets revisit this later...
  #  test_data <- filter(games_ml,season==testing_year)
  #}
  
    
  summary_df <- select(test_data,c('game_id','home_score','away_score','spread_line',
                                    'winner_ha','winner_01','home_moneyline','away_moneyline',
                                   'mean_moneyline_prob'))

  
  #edit models here
  summary_df$pr_mod_point_dd <- predict(glm(winner_01 ~ point_diff_diff, 
                                           family = binomial, data=train_data),
                                       test_data,type='response')
  summary_df$pr_mod_wins_dif <- predict(glm(winner_01 ~ wins_diff, 
                                           family = binomial, data=train_data),
                                       test_data,type='response')
  summary_df$pr_mod_pdd_wd_i <- predict(glm(winner_01 ~ (wins_diff+point_diff_diff)^2, 
                                           family = binomial, data=train_data),
                                       test_data,type='response')
  summary_df$pr_mod_all_2i_no_vegas <- predict(glm(winner_01 ~ (wins_diff+
                                                                  rest_diff+
                                                                  home_incoming_points_scored_pg+
                                                                  home_incoming_points_allowed_pg+
                                                                  away_incoming_points_scored_pg+
                                                                  away_incoming_points_allowed_pg+
                                                                  home_incoming_ypp+
                                                                  home_incoming_ypp_a+
                                                                  away_incoming_ypp+
                                                                  away_incoming_ypp_a)^2, 
                                           family = binomial, data=train_data),
                                       test_data,type='response')
  summary_df$pr_mod_OF <- predict(glm(winner_01 ~ (spread_line+
                                                    point_diff_diff+
                                                    wins_diff+
                                                    rest_diff+
                                                    mean_moneyline_prob)^5, 
                                           family = binomial, data=train_data),
                                       test_data,type='response')
  summary_df$pr_mod_pr <- predict(glm(winner_01 ~ pagerank_diff, family = binomial, data = train_data), test_data, type = 'response')  
  
  
  #edit "custom" predictions here
  summary_df$pr_constant <- mean(train_data$winner_01)
  
  summary_df$pr_moneyline <- test_data$mean_moneyline_prob
  
  summary_df$pr_home <- .999
  
  summary_df$pr_away <- .001
  
  summary_df$pr_fav <- (test_data$mean_moneyline_prob > 0.5)*.998 +.001
  
  summary_df$pr_dog <- 1 - summary_df$pr_fav
  return(summary_df)
}
```

```{r}
get_preds_df()
```

### Profitability against the moneylines, including the house edge

```{r}
#compute profit for single game
compute_profit <- function(result, ml_home, ml_away, bet){
  if((bet>0) & (result==1)){
    if(ml_home>0){
      return(bet/100*ml_home)
    }
    return(100/abs(ml_home)*bet)
  }
  if((bet<0) & (result==0)){
    if(ml_away>0){
      return(abs(bet/100*ml_away))
    }
    return(abs(100/abs(ml_away)*bet))
  }
  return(-abs(bet))
}

#profitabilty for many games, can return
compute_profitability <- function(results,ml_home,ml_away,preds, extra_info=c()){
  ml_hi <- ifelse(ml_home>0 , 100 / (ml_home+100) , abs(ml_home) / (abs(ml_home)+100) )
  ml_lo <- 1-ifelse(ml_away>0 , 100 / (ml_away+100) , abs(ml_away) / (abs(ml_away)+100) )
  
  to_bet <- ifelse(preds>ml_hi , 1,
                       ifelse(preds<ml_lo, -1, 0)) #home=1, away=-1, none = 0 (consider adjusting amount here)
  
  profits <- c()
  for(i in 1:length(results)){
    profits[i] <- compute_profit(results[i],ml_home[i],ml_away[i],to_bet[i])
  }
  if(length(extra_info)==0){
    return(sum(profits)/sum(abs(to_bet)))
  }
  to_return <- data.frame(extra_info=extra_info,
                          home_win = results,
                          ml_home=ml_home,
                          ml_away=ml_away,
                          ml_hi=ml_hi,
                          ml_lo=ml_lo,
                          preds=preds,
                          to_bet=to_bet,
                          profits=profits)
  return(to_return)
}

#consider adjusting bet amount to how much predicted is different from ml
```

```{r}
compute_profit(0,134,-124,-1) #The weird 2020 game had an error?
```


```{r}
#example
compute_profitability(games_ml$winner_01,games_ml$home_moneyline,games_ml$away_moneyline,
                      predict(glm(winner_01 ~ point_diff_diff, 
                                           family = binomial, data=games_ml),
                                       games_ml,type='response'),
                      extra_info = games_ml$game_id)
```

```{r}
get_year_summaries <- function(training_years=4,
                               years=2010:2024){
  return_df <- data.frame()
  for(year in years){
    summary_df <- get_preds_df(training_years = training_years, testing_year=year)
    year_sum_df <- data.frame()
    for (name in names(summary_df)) {
      if(startsWith(name,'pr_')){
        accuracy <- mean((select(summary_df,name)>0.5) == summary_df$winner_01)
        log_loss <- logLoss(summary_df$winner_01 , select(summary_df,name)[,1])
        profit <- compute_profitability(summary_df$winner_01,
                                        summary_df$home_moneyline,
                                        summary_df$away_moneyline,
                                        select(summary_df,name))
        
        method_sum <- data.frame(year=year, method=name, 
                                 accuracy=accuracy, 
                                 log_loss=log_loss,
                                 profit=profit)
        year_sum_df <- rbind(year_sum_df,method_sum)
      }
    }
    return_df <- rbind(return_df,year_sum_df)
  }
  return(return_df)
}
```

```{r}
year_sum_df <- get_year_summaries(years=2010:2024)

ggplot(year_sum_df,aes(x=year, y=profit ,color=method)) + geom_line() + geom_point() +
  ylim(-.25,.25) +
  labs(title = 'Betting Methods Profit by Year')+
  scale_color_brewer(palette = "Set1")
```


### visualize model probs vs. vegas probs


```{r}
year <- 2023
training_years <- 3

df <- get_preds_df(training_years=training_years, testing_year=year)

prof_df <- compute_profitability(df$winner_01,
                      df$home_moneyline,
                      df$away_moneyline,
                      df$pr_mod_all_2i_no_vegas, #change model here if desired
                      extra_info=select(df,c(game_id, home_score, away_score, winner_ha,mean_moneyline_prob)))

#prof_df$profits[prof_df$profits == 0] <- NA
color.values = c('-1'="red",'0'='grey','1'="green")
p<- ggplot(prof_df,aes(x=extra_info.mean_moneyline_prob, 
                       text=paste(extra_info.game_id, "<br>", extra_info.away_score,"-",extra_info.home_score,
                                  "<br> Profit:",profits), 
                       color=factor(sign(profits)),
                       shape=extra_info.winner_ha,
                       size=abs(profits)))+
  geom_point(aes(y=preds), alpha=0.5)+
  geom_abline(slope=1, intercept=0, alpha=0.2) +
  geom_hline(yintercept=.5, alpha=0.2)+
  geom_vline(xintercept=.5, alpha=0.2)+
  labs(title=paste('Total Profit',round(100*sum(prof_df$profits)/sum(abs(prof_df$to_bet)),2),'%'))+
  #scale_shape_manual(values = c('home'='H','away'='A'))+
  scale_color_manual(values=color.values)
  #scale_color_gradient2(midpoint = 0, low = "red", mid = "grey", high = "green")
  #scale_color_gradientn(colours = c("red", "grey", "green"),
  #                     values = scales::rescale(c(min(prof_df$profits), -0.1, 0, 0.1, max(prof_df$profits))))

ggplotly(p, tooltip="text")
```


```{r}
games <- games %>% mutate(
  home_incoming_points_scored_pg = home_incoming_points_scored / (home_incoming_games+.001),
  away_incoming_points_scored_pg = away_incoming_points_scored / (away_incoming_games+.001),
  home_incoming_points_allowed_pg = home_incoming_points_allowed / (home_incoming_games+.001),
  away_incoming_points_allowed_pg = away_incoming_points_allowed / (away_incoming_games+.001),
)

games_c <- filter(games,home_score>-1) #completed games

games_sc <- data.frame(scale(select_if(games_c, is.numeric))) #scaled for mean 0 and sd 1
games_sc$winner_01 <- as.numeric(games_c$winner_01)

mod <- glm(winner_01 ~ (wins_diff+
                  rest_diff+
                  home_incoming_points_scored_pg+
                  home_incoming_points_allowed_pg+
                  away_incoming_points_scored_pg+
                  away_incoming_points_allowed_pg+
                  home_incoming_ypp+
                  home_incoming_ypp_a+
                  away_incoming_ypp+
                  away_incoming_ypp_a)^2, 
                  family = binomial, data=games_sc)

data.frame(mod$coefficients) %>% arrange(-mod.coefficients)
```

## Randomized betting (p-value style comparison)

```{r}
trials <- 1000
rand_profit_results <- data.frame(trial = 1:trials)

for(year in 2006:2023){
  year_games <- filter(games_ml,season==year,home_score>-1)
  profits <- c()
  for(i in 1:trials){
    rand_picks <- sample(c(-1,1),nrow(year_games),replace=TRUE)
    profits[i] <- compute_profitability(year_games$winner_01,
                                          year_games$home_moneyline,
                                          year_games$away_moneyline,
                                          rand_picks)
  }
  col_name <- paste0('',year)
  rand_profit_results[[col_name]] <- profits
}

colMeans(rand_profit_results)
```

```{r}
#compute simple betting strategy summaries for each year
strategy_summarys <- data.frame()

for(year in 2007:2023){
  year_games <- filter(games_ml,season==year,home_score>-1, game_type=='REG')
  profits <- c()
  bet_home <- compute_profitability(year_games$winner_01,year_games$home_moneyline,year_games$away_moneyline,
                                    rep(1,nrow(year_games)))
  bet_away <- compute_profitability(year_games$winner_01,year_games$home_moneyline,year_games$away_moneyline,
                                    rep(0,nrow(year_games)))
  bet_fav <- compute_profitability(year_games$winner_01,year_games$home_moneyline,year_games$away_moneyline,
                                    ifelse(year_games$mean_moneyline_prob>.5 , 1, 0))
  bet_dog <- compute_profitability(year_games$winner_01,year_games$home_moneyline,year_games$away_moneyline,
                                    ifelse(year_games$mean_moneyline_prob<.5 , 1, 0))
  bet_home_dog <- compute_profitability(year_games$winner_01,year_games$home_moneyline,year_games$away_moneyline,
                                    ifelse(year_games$mean_moneyline_prob<.5 , 1, year_games$mean_moneyline_prob))
  
  #start here
  year_sum <- data.frame(year = year,
                         bet_home = bet_home,
                         bet_away = bet_away,
                         bet_fav = bet_fav,
                         bet_dog = bet_dog,
                         bet_home_dog = bet_home_dog)
  
  strategy_summarys <- rbind(strategy_summarys,year_sum)
}

ggplot(strategy_summarys,aes(x=year))+
  geom_line(aes(y=bet_home,color='home'))+
  geom_line(aes(y=bet_away,color='away'))+
  geom_line(aes(y=bet_fav,color='fav'))+
  geom_line(aes(y=bet_dog,color='dog'))+
  geom_line(aes(y=bet_home_dog,color='home dog'))+
  geom_point(aes(y=bet_home,color='home'))+
  geom_point(aes(y=bet_away,color='away'))+
  geom_point(aes(y=bet_fav,color='fav'))+
  geom_point(aes(y=bet_dog,color='dog'))+
  geom_point(aes(y=bet_home_dog,color='home dog'))+
  labs(title = 'Profitability of simple bet strategies', y='Profit')
```


##Eigenvalues and Page Rank
```{r}
#-------------------(GET RESULTS MATRIX)-------------------------------
get_results_matrix <- function(season_wanted, week_wanted, game_dataset){       #week means including that
  #ij entry means that i beat j by 7 if 7 is entry
  prior_games <- filter(game_dataset, season==season_wanted, week<=week_wanted)
  prior_games$home_team <- as.character(prior_games$home_team)
  prior_games$away_team <- as.character(prior_games$away_team)
  all_teams <- as.character(sort (c('DET','MIN', 'GB', 'CHI',
                  'TB','ATL', 'CAR', 'NO',
                   'HOU','IND', 'JAX', 'TEN',
                   'BAL', 'PIT', 'CIN', 'CLE',
                   'KC', 'LAC', 'DEN', 'LV',
                   'BUF', 'MIA', 'NYJ', 'NE',
                   'PHI', 'WAS', 'DAL', 'NYG',
                   'LA', 'SEA', 'ARI', 'SF')))
  teams_matrix <- data.frame(matrix(0,nrow=32, ncol=32), row.names = all_teams)
  colnames(teams_matrix) <- all_teams
  
  if (week_wanted==0){
    return(teams_matrix)
  }
  
  for (i in 1:nrow(prior_games)) {
    result <- prior_games[i,]$result
    home <- prior_games[i,]$home_tea
    away <- prior_games[i,]$away_team
    if (result > 0){
      teams_matrix[home, away] <- result + teams_matrix[home,away]
    }else{
      teams_matrix[away,home] <- abs(result) + teams_matrix[away,home]
  }
  

  }
    return(teams_matrix)
}


#--------------------------------(GET PAGE RANK)------------------------------------------

get_pagerank <- function(season_wanted, week_wanted, game_dataset, show_graph = FALSE){
  if(week_wanted == 0){
    all_teams <- sort (c('DET','MIN', 'GB', 'CHI',
                  'TB','ATL', 'CAR', 'NO',
                   'HOU','IND', 'JAX', 'TEN',
                   'BAL', 'PIT', 'CIN', 'CLE',
                   'KC', 'LAC', 'DEN', 'LV',
                   'BUF', 'MIA', 'NYJ', 'NE',
                   'PHI', 'WSH', 'DAL', 'NYG',
                   'LA', 'SEA', 'ARI', 'SF'))
    pr_matrix <- data.frame(matrix(1/32, nrow = 1, ncol = length(all_teams)))
    colnames(pr_matrix) <- all_teams
    return(pr_matrix)
  }
  teams_matrix <- get_results_matrix(season_wanted, week_wanted, game_dataset)
  graph_adj_matrix <- graph_from_adjacency_matrix(t(data.matrix(teams_matrix)), weighted = TRUE)
  if (show_graph == TRUE){
    plot(graph_adj_matrix)
  }
  return(data.frame(t(page_rank(graph_adj_matrix, algo = c("prpack"))$vector)))

}


#----------------------------(Plotting 1 week)---------------------

g<- graph_from_adjacency_matrix(t(data.matrix(teams_matrix)), weighted = TRUE)

#1 NFC N - DET, MIN, GB, CHI 
#2 NFC S - TB, ATL, CAR, NO
#3 AFC S - HOU, IND, JAX, TEN
#4 AFC N - BAL, PIT, CIN, CLE
#5 AFC W - KC, LAC, DEN, LV
#6 AFC E - BUF, MIA, NYJ, NE
#7 NFC E - PHI, WSH, DAL, NYG
#8 NFC W - LA, SEA, ARI, SF

teams_list <- list(list('DET','MIN', 'GB', 'CHI'),
                   list('TB','ATL', 'CAR', 'NO'),
                   list('HOU','IND', 'JAX', 'TEN'),
                   list('BAL', 'PIT', 'CIN', 'CLE'),
                   list('KC', 'LAC', 'DEN', 'LV'),
                   list('BUF', 'MIA', 'NYJ', 'NE'),
                   list('PHI', 'WAS', 'DAL', 'NYG'),
                   list('LA', 'SEA', 'ARI', 'SF'))
teams_teams <- c('DET','MIN', 'GB', 'CHI',
                  'TB','ATL', 'CAR', 'NO',
                   'HOU','IND', 'JAX', 'TEN',
                   'BAL', 'PIT', 'CIN', 'CLE',
                   'KC', 'LAC', 'DEN', 'LV',
                   'BUF', 'MIA', 'NYJ', 'NE',
                   'PHI', 'WAS', 'DAL', 'NYG',
                   'LA', 'SEA', 'ARI', 'SF')

xs<-c()
ys<-c()
for(n in 1:8){
  xs[n] <- cos(n * pi / 4 - pi / 8)
  ys[n] <- sin(n * pi / 4 - pi / 8)
}
centers <- Map(c,xs,ys)
r <- .2
m <- matrix(,nrow = 2, ncol = 32)
teams_position <- data.frame(m)
colnames(teams_position) <- teams_teams

for (n in 1:8){
  for ( ti in 1:4){
    angle <- (ti*pi/2 - pi/4) + (n * pi / 4 - pi / 8)
    x_coor <- centers[[n]][1] + r*cos(angle)
    y_coor <- centers[[n]][2] + r*sin(angle)
    teams_position[paste(teams_list[[n]][ti])] <- c(x_coor, y_coor)
  }
}

team_colors <- list(
  DET = list(primary = "#0076B6", secondary = "#B0B7BC"),  # Detroit Lions
  MIN = list(primary = "#4F2683", secondary = "#FFC62F"),  # Minnesota Vikings
  GB = list(primary = "#203731", secondary = "#FFB81C"),  # Green Bay Packers
  CHI = list(primary = "#0B162A", secondary = "#FB4F14"),  # Chicago Bears
  TB = list(primary = "#D50A0A", secondary = "#8A8D8F"),  # Tampa Bay Buccaneers
  ATL = list(primary = "#A71930", secondary = "#000000"),  # Atlanta Falcons
  CAR = list(primary = "#0085CA", secondary = "#000000"),  # Carolina Panthers
  NO = list(primary = "#D3BC8D", secondary = "#000000"),  # New Orleans Saints
  HOU = list(primary = "#03202F", secondary = "#C8102E"),  # Houston Texans
  IND = list(primary = "#003D73", secondary = "#FFFFFF"),  # Indianapolis Colts
  JAX = list(primary = "#006778", secondary = "#000000"),  # Jacksonville Jaguars
  TEN = list(primary = "#000080", secondary = "#006F92"),  # Tennessee Titans
  BAL = list(primary = "#68228B", secondary = "#000000"),  # Baltimore Ravens
  PIT = list(primary = "#FFB81C", secondary = "#101820"),  # Pittsburgh Steelers
  CIN = list(primary = "#FB4F14", secondary = "#000000"),  # Cincinnati Bengals
  CLE = list(primary = "#311D00", secondary = "#FF3C00"),  # Cleveland Browns
  KC = list(primary = "#E31837", secondary = "#FFB81C"),  # Kansas City Chiefs
  LAC = list(primary = "#0085CA", secondary = "#FFC72C"),  # Los Angeles Chargers
  DEN = list(primary = "#002244", secondary = "#FB4F14"),  # Denver Broncos
  LV = list(primary = "#101820", secondary = "#B5B8B1"),  # Las Vegas Raiders
  BUF = list(primary = "#00338D", secondary = "#C60C30"),  # Buffalo Bills
  MIA = list(primary = "#008E97", secondary = "#F58220"),  # Miami Dolphins
  NYJ = list(primary = "#117A65", secondary = "#FFFFFF"),  # New York Jets
  NE = list(primary = "#002244", secondary = "#C60C30"),  # New England Patriots
  PHI = list(primary = "#004C54", secondary = "#A5ACAF"),  # Philadelphia Eagles
  WAS = list(primary = "#772C1F", secondary = "#FFB81C"),  # Washington Commanders
  DAL = list(primary = "#0060A9", secondary = "#86949D"),  # Dallas Cowboys
  NYG = list(primary = "#0B2265", secondary = "#AA0000"),  # New York Giants
  LA  = list(primary = "#0047AB", secondary = "#FFD100"),  # Los Angeles Rams
  SEA = list(primary = "#002A5C", secondary = "#69BE28"),  # Seattle Seahawks
  ARI = list(primary = "#CD0000", secondary = "#000000"),  # Arizona Cardinals
  SF  = list(primary = "#AA0000", secondary = "#B3995D")   # San Francisco 49ers
)


vertex_colors <- sapply(V(g)$name, function(team) team_colors[[team]]$primary)
border_colors <- sapply(V(g)$name, function(team) team_colors[[team]]$secondary)
layout_matrix <- t(as.matrix(teams_position[, match(V(g)$name, colnames(teams_position))]))

teams <- V(g)$name

# Create a named vector for PageRank values from final_games
team_pagerank <- setNames(final_games$home_pagerank, final_games$home_team)
team_pagerank <- c(team_pagerank, setNames(final_games$away_pagerank, final_games$away_team))

# Assign PageRank values to vertices, using a fallback for missing values
week_team_prank <- sapply(teams, function(team) team_pagerank[team] %||% mean(team_pagerank, na.rm = TRUE))

# Normalize sizes for better visualization (optional)
week_team_prank <- scales::rescale(week_team_prank, to = c(10, 40))  # Adjust range as needed

plot.igraph(g, 
  vertex.label = V(g)$name,               
  vertex.label.color = border_colors,           
  vertex.size = week_team_prank,                        
  vertex.label.cex = .7,
  vertex.color = vertex_colors,            
  vertex.frame.color = border_colors,      
  vertex.shape = "circle",                 
  edge.arrow.size = 0.5,                   
  edge.color = rgb(0,0,0,.35),                    
  edge.width = E(g)$weight /5,
  edge.alpha = .1,
  edge.curved = FALSE,                      
  layout = layout_matrix              
)
```

```{r}
#------------------(Function to plot specific week)---------------------

team_colors <- list(
  DET = list(primary = "#0076B6", secondary = "#B0B7BC"),  # Detroit Lions
  MIN = list(primary = "#4F2683", secondary = "#FFC62F"),  # Minnesota Vikings
  GB = list(primary = "#203731", secondary = "#FFB81C"),  # Green Bay Packers
  CHI = list(primary = "#0B162A", secondary = "#FB4F14"),  # Chicago Bears
  TB = list(primary = "#D50A0A", secondary = "#8A8D8F"),  # Tampa Bay Buccaneers
  ATL = list(primary = "#A71930", secondary = "#000000"),  # Atlanta Falcons
  CAR = list(primary = "#0085CA", secondary = "#000000"),  # Carolina Panthers
  NO = list(primary = "#D3BC8D", secondary = "#000000"),  # New Orleans Saints
  HOU = list(primary = "#03202F", secondary = "#C8102E"),  # Houston Texans
  IND = list(primary = "#003D73", secondary = "#FFFFFF"),  # Indianapolis Colts
  JAX = list(primary = "#006778", secondary = "#000000"),  # Jacksonville Jaguars
  TEN = list(primary = "#000080", secondary = "#006F92"),  # Tennessee Titans
  BAL = list(primary = "#68228B", secondary = "#000000"),  # Baltimore Ravens
  PIT = list(primary = "#FFB81C", secondary = "#101820"),  # Pittsburgh Steelers
  CIN = list(primary = "#FB4F14", secondary = "#000000"),  # Cincinnati Bengals
  CLE = list(primary = "#311D00", secondary = "#FF3C00"),  # Cleveland Browns
  KC = list(primary = "#E31837", secondary = "#FFB81C"),  # Kansas City Chiefs
  LAC = list(primary = "#0085CA", secondary = "#FFC72C"),  # Los Angeles Chargers
  DEN = list(primary = "#002244", secondary = "#FB4F14"),  # Denver Broncos
  LV = list(primary = "#101820", secondary = "#B5B8B1"),  # Las Vegas Raiders
  BUF = list(primary = "#00338D", secondary = "#C60C30"),  # Buffalo Bills
  MIA = list(primary = "#008E97", secondary = "#F58220"),  # Miami Dolphins
  NYJ = list(primary = "#117A65", secondary = "#FFFFFF"),  # New York Jets
  NE = list(primary = "#002244", secondary = "#C60C30"),  # New England Patriots
  PHI = list(primary = "#004C54", secondary = "#A5ACAF"),  # Philadelphia Eagles
  WAS = list(primary = "#772C1F", secondary = "#FFB81C"),  # Washington Commanders
  DAL = list(primary = "#0060A9", secondary = "#86949D"),  # Dallas Cowboys
  NYG = list(primary = "#0B2265", secondary = "#AA0000"),  # New York Giants
  LA  = list(primary = "#0047AB", secondary = "#FFD100"),  # Los Angeles Rams
  SEA = list(primary = "#002A5C", secondary = "#69BE28"),  # Seattle Seahawks
  ARI = list(primary = "#CD0000", secondary = "#000000"),  # Arizona Cardinals
  SF  = list(primary = "#AA0000", secondary = "#B3995D")   # San Francisco 49ers
)

byweekviz <- function(season_wanted, week_wanted, game_dataset){
  
  teams_matrix <- get_results_matrix(season_wanted, week_wanted, game_dataset)
  g<- graph_from_adjacency_matrix(t(data.matrix(teams_matrix)), weighted = TRUE)
  teams <- V(g)$name
  
  week_team_prank <- get_pagerank(season_wanted, week_wanted, game_dataset)
  week_team_prank <- scales::rescale(as.numeric(week_team_prank), to = c(10, 40),from = c(0,.2))
  
  vertex_colors <- sapply(teams, function(team) team_colors[[team]]$primary)
  border_colors <- sapply(teams, function(team) team_colors[[team]]$secondary)
  layout_matrix <- t(as.matrix(teams_position[, match(teams, colnames(teams_position))]))
  
  return(plot.igraph(g, 
  vertex.label = teams,               
  vertex.label.color = border_colors,           
  vertex.size = week_team_prank,                        
  vertex.label.cex = .7,
  vertex.color = vertex_colors,            
  vertex.frame.color = border_colors,      
  vertex.shape = "circle",                 
  edge.arrow.size = 0.5,                   
  edge.color = rgb(0,0,0,.35),                    
  edge.width = E(g)$weight /5,
  edge.curved = FALSE,                      
  layout = layout_matrix)              
)
  
}

byweekviz(2003,5,final_games)


seasonviz <- function(season_wanted, week_wanted, game_dataset) {
  if (!dir.exists("PageRankViz")) {
    dir.create("PageRankViz")
  }
  
  for (week in 0:week_wanted) {
    file_name <- sprintf("PageRankViz/%d_Week%d.png", season_wanted, week)

    tryCatch({
      png(filename = file_name, width = 800, height = 800)
      byweekviz(season_wanted, week, game_dataset)
      dev.off()
    }, error = function(e) {
      message("Error in png(): ", e$message)
    })
  }
}

seasonviz(2004, 21, final_games)
```

```{r}
#pagerank logistic regression

final_games$pagerank_diff <- final_games$home_pagerank - final_games$away_pagerank

final_games_sum_pr <- final_games %>%
  group_by(round(pagerank_diff,2)) %>% 
  summarize(home_win_perc = mean(winner_01),
            count = n())

ggplot(final_games_sum_pr, aes(x=`round(pagerank_diff, 2)`,y=home_win_perc, weight = count)) +
         geom_point(aes(size=count),alpha=0.5)+
  geom_smooth(data = final_games_sum_pr,
              method='glm',
              formula = y ~ x,
              method.args = c(family = "binomial"),
              se=TRUE) +
  labs(title = 'Logistic Model for Home PageRank', y='Home Win Prob')
```


THIS WAS USED TO APPEND THE PAGE RANK TO DATA THEN MAKE FINAL GAMES
```{r}
#adding pr to games
home_pagerank <- c()
away_pagerank <- c()
for (i in 1:nrow(games)) {
  home_pagerank[i] <- as.numeric(get_pagerank(games[i,]$season,
                             games[i,]$week-1 ,
                             games)[games[i,]$home_team])
  away_pagerank[i] <- as.numeric(get_pagerank(games[i,]$season,
                                 games[i,]$week-1,
                                 games)[games[i,]$away_team])
}
games$home_pagerank <- home_pagerank
games$away_pagerank <- away_pagerank

games$home_pagerank

games[i,]

```

```{r}

get_results_matrix <- function(season_wanted, week_wanted, game_dataset) {
  prior_games <- filter(game_dataset, season == season_wanted, week <= week_wanted)
  all_teams <- sort(unique(c(game_dataset$home_team, game_dataset$away_team)))  # Ensuring all teams are included
  num_teams <- length(all_teams)
  
  teams_matrix <- matrix(0, nrow = num_teams, ncol = num_teams, 
                         dimnames = list(all_teams, all_teams))
  
  for (i in 1:nrow(prior_games)) {
    result <- prior_games$result[i]
    home <- prior_games$home_team[i]
    away <- prior_games$away_team[i]
    
    if (result > 0) {
      teams_matrix[home, away] <- teams_matrix[home, away] + result
    } else {
      teams_matrix[away, home] <- teams_matrix[away, home] + abs(result)
    }
  }
  
  return(as.data.frame(teams_matrix))
}

get_pagerank <- function(season_wanted, week_wanted, game_dataset, show_graph = FALSE) {
  if (week_wanted == 0) {
    all_teams <- sort(unique(c(game_dataset$home_team, game_dataset$away_team)))
    pr_matrix <- data.frame(matrix(1/length(all_teams), nrow = 1, ncol = length(all_teams)))
    colnames(pr_matrix) <- all_teams
    return(pr_matrix)
  }
  
  teams_matrix <- get_results_matrix(season_wanted, week_wanted, game_dataset)
  graph_adj_matrix <- graph_from_adjacency_matrix(t(data.matrix(teams_matrix)), weighted = TRUE)
  
  if (show_graph) {
    plot(graph_adj_matrix)
  }
  
  pr_vector <- page_rank(graph_adj_matrix, algo = "prpack")$vector
  pr_matrix <- data.frame(t(pr_vector))
  colnames(pr_matrix) <- colnames(teams_matrix)  # Ensure correct team names
  
  return(pr_matrix)
}

# Pre-allocate vectors
home_pagerank <- numeric(nrow(games))
away_pagerank <- numeric(nrow(games))

for (i in 1:nrow(games)) {
  season <- games$season[i]
  week <- games$week[i] - 1
  home_team <- games$home_team[i]
  away_team <- games$away_team[i]
  
  pr_table <- get_pagerank(season, week, games)
  
  if (home_team %in% colnames(pr_table)) {
    home_pagerank[i] <- as.numeric(pr_table[home_team])
  } else {
    home_pagerank[i] <- 1/length(unique(c(games$home_team, games$away_team)))  # Default if missing
  }
  
  if (away_team %in% colnames(pr_table)) {
    away_pagerank[i] <- as.numeric(pr_table[away_team])
  } else {
    away_pagerank[i] <- 1/length(unique(c(games$home_team, games$away_team)))  # Default if missing
  }
}

games$home_pagerank <- home_pagerank
games$away_pagerank <- away_pagerank

games
```

```{r}
get_last5incoming_ypp <- function(season_num,
                             week_num,
                             team_name){
  prior_games <-all_fastR_team_stats %>%
  filter(team == team_name, 
         (season == season_num & week < week_num) |  
         (season == season_num - 1 & week >= week_num)) %>%  
  arrange(season, week)%>%  
  tail(5) 
  
  prior_games <- mutate(prior_games,
                  plays = attempts + sacks_suffered + carries,
                  tot_yards = passing_yards + rushing_yards + sack_yards_lost)
  if(sum(prior_games$plays)>0){
    return(sum(prior_games$tot_yards)/sum(prior_games$plays))
  }
}

get_last5incoming_ypp_a <- function(season_num,
                             week_num,
                             team_name){
  prior_games <-all_fastR_team_stats %>%
  filter(team == team_name, 
         (season == season_num & week < week_num) |  
         (season == season_num - 1 & week >= week_num)) %>%  
  arrange(season, week)%>%  
  tail(5) 

  prior_games <- mutate(prior_games,
                  plays = attempts + sacks_suffered + carries,
                  tot_yards = passing_yards + rushing_yards + sack_yards_lost)
  if(sum(prior_games$plays)>0){
    return(sum(prior_games$tot_yards)/sum(prior_games$plays))
  }
}


get_last10results_matrix <- function(season_num, week_num, game_dataset) {
  prior_games <- filter(game_dataset, 
         (season == season_num & week < week_num) |  
         (season == season_num - 1 & week >= week_num)) %>%  
  arrange(season, week)%>%  
  tail(160) 
  all_teams <- as.character(sort (c('DET','MIN', 'GB', 'CHI',
                  'TB','ATL', 'CAR', 'NO',
                   'HOU','IND', 'JAX', 'TEN',
                   'BAL', 'PIT', 'CIN', 'CLE',
                   'KC', 'LAC', 'DEN', 'LV',
                   'BUF', 'MIA', 'NYJ', 'NE',
                   'PHI', 'WAS', 'DAL', 'NYG',
                   'LA', 'SEA', 'ARI', 'SF')))
  all_teams <- sort(unique(c(game_dataset$home_team, game_dataset$away_team)))  # Ensuring all teams are included
  num_teams <- length(all_teams)
  
  teams_matrix <- matrix(0, nrow = num_teams, ncol = num_teams, 
                         dimnames = list(all_teams, all_teams))
  
  for (i in 1:nrow(prior_games)) {
    result <- prior_games$result[i]
    home <- prior_games$home_team[i]
    away <- prior_games$away_team[i]
    
    if (result > 0) {
      teams_matrix[home, away] <- teams_matrix[home, away] + result
    } else {
      teams_matrix[away, home] <- teams_matrix[away, home] + abs(result)
    }
  }
  
  return(as.data.frame(teams_matrix))
}

get_last10_pagerank <- function(season_wanted, week_wanted, game_dataset, show_graph = FALSE) {
  if (week_wanted == 0) {
    all_teams <- sort(unique(c(game_dataset$home_team, game_dataset$away_team)))
    pr_matrix <- data.frame(matrix(1/length(all_teams), nrow = 1, ncol = length(all_teams)))
    colnames(pr_matrix) <- all_teams
    return(pr_matrix)
  }
  
  teams_matrix <- get_last10results_matrix(season_wanted, week_wanted, game_dataset)
  graph_adj_matrix <- graph_from_adjacency_matrix(t(data.matrix(teams_matrix)), weighted = TRUE)
  
  pr_vector <- page_rank(graph_adj_matrix, algo = "prpack")$vector
  pr_matrix <- data.frame(t(pr_vector))
  colnames(pr_matrix) <- colnames(teams_matrix)  # Ensure correct team names
  
  return(pr_matrix)
}
```


```{r}
n_games <- nrow(final_games)

last5_home_wins <- c()
last5_away_wins <- c()

last5_home_pointsscored <- c()
last5_away_pointsscored <- c()

last5_home_pointsallowed <-c()
last5_away_pointsallowed <-c()

last5_home_ypp <- c()
last5_away_ypp <- c()

last5_home_ypp_a <- c()
last5_away_ypp_a <- c()

last10_wins_home <- c()
last10_wins_away <- c()

last10_home_pagerank <- numeric(nrow(final_games))
last10_away_pagerank <- numeric(nrow(final_games))


for (i in 1:n_games) {
  cur_home_team <- final_games[i, ]$home_team
  cur_away_team <- final_games[i, ]$away_team
  cur_week <- final_games[i, ]$week
  cur_season <- final_games[i, ]$season
  
  if (cur_season >=2004){
  
  # Last 5 games for home and away team
  home_last5 <- final_games %>%
    filter(home_team == cur_home_team | away_team == cur_home_team,
           season <= cur_season,
           week <= cur_week | season < cur_season) %>%
    arrange(season, week) %>%
    tail(5)

  away_last5 <- final_games %>%
    filter(home_team == cur_away_team | away_team == cur_away_team,
           season <= cur_season,
           week < cur_week | season < cur_season) %>%
    arrange(season, week) %>%
    tail(5)

  # Wins in last 5
  last5_home_wins[i] <- sum(as.character(home_last5$winner_team) == as.character(cur_home_team))
  last5_away_wins[i] <- sum(as.character(away_last5$winner_team) == as.character(cur_away_team))

  

  # Points scored and allowed - Home
  total_points <- 0
  total_points_allowed <- 0
  for (j in 1:nrow(home_last5)) {
    if (home_last5$home_team[j]== cur_home_team) {
      total_points <- total_points + home_last5$home_score[j]
      total_points_allowed <- total_points_allowed + home_last5$away_score[j]
    } else {
      total_points <- total_points + home_last5$away_score[j]
      total_points_allowed <- total_points_allowed + home_last5$home_score[j]
    }
  }
  last5_home_pointsscored[i] <- total_points
  last5_home_pointsallowed[i] <- total_points_allowed
  
  # Points scored and allowed - Away
  away_total_points <- 0
  away_total_points_allowed <- 0
  for (j in 1:nrow(away_last5)) {
    if (away_last5$away_team[j] == cur_away_team) {
      away_total_points <- away_total_points + away_last5$away_score[j]
      away_total_points_allowed <- away_total_points_allowed + away_last5$home_score[j]
    } else {
      away_total_points <- away_total_points + away_last5$home_score[j]
      away_total_points_allowed <- away_total_points_allowed + away_last5$away_score[j]
    }
  }
  last5_away_pointsscored[i] <- away_total_points
  last5_away_pointsallowed[i] <- away_total_points_allowed
  
  #Home and Away Last 5 Yards Per Play Allowed
  last5_home_ypp[i] <- get_last5incoming_ypp(season_num=cur_season, 
                                             week_num=cur_week,
                                             team_name=cur_home_team)
  last5_home_ypp_a[i] <- get_last5incoming_ypp_a(season_num=cur_season,
                                                 week_num=cur_week,
                                                 team_name=cur_home_team)
  last5_away_ypp[i] <- get_last5incoming_ypp(season_num=cur_season,
                             week_num=cur_week,
                             team_name=cur_away_team)
  last5_away_ypp_a[i] <- get_last5incoming_ypp_a(season_num=cur_season,
                                 week_num=cur_week,
                                 team_name=cur_away_team)
    
  #home team last 10 wins
  cur_home_team = final_games[i, ]$home_team
  cur_week = final_games[i, ]$week
  cur_season = final_games[i, ]$season
  home_last10 <- filter(final_games, home_team==cur_home_team | away_team==cur_home_team)%>%
    tail(10)
  last10_wins_home[i] <- sum(as.character(home_last10$winner_team) == as.character(cur_home_team))
  
  #away team last 10 wins
  cur_away_team = final_games[i, ]$away_team
  away_last10 <- filter(final_games, home_team==cur_away_team | away_team==cur_away_team)%>%
    tail(10)
  last10_wins_away[i] <- sum(as.character(away_last10$winner_team) == as.character(cur_away_team))
    
  #Home and Away Last 10 Page Rank 
    season <- final_games$season[i]
    week <- final_games$week[i] -1 
    home_team <- cur_home_team
    away_team <- cur_away_team
  
      pr_table <- get_last10_pagerank(season, week, final_games)
  
      if (cur_home_team %in% colnames(pr_table)) {
        last10_home_pagerank[i] <- as.numeric(pr_table[cur_home_team])
      } else {
        last10_home_pagerank[i] <- 1/length(unique(c(games$cur_home_team, games$cur_away_team)))  # Default if missing
      }
  
      if (cur_away_team %in% colnames(pr_table)) {
        last10_away_pagerank[i] <- as.numeric(pr_table[cur_away_team])
    } else {
        last10_away_pagerank[i] <- 1/length(unique(c(games$cur_home_team, games$cur_away_team)))  # Default if missing
    }
  }
  else {
      last5_home_wins[i] <- 0
      last5_away_wins[i] <- 0
      last5_home_pointsscored[i] <- 0
      last5_home_pointsallowed[i] <- 0
      last5_away_pointsscored[i] <- 0
      last5_away_pointsallowed[i] <- 0
      last5_home_ypp[i] <- 0
      last5_home_ypp_a[i] <- 0
      last5_away_ypp[i] <- 0
      last5_away_ypp_a[i] <- 0
      last10_wins_home[i] <- 0
      last10_wins_away[i] <- 0
      last10_home_pagerank[i] <- 0
      last10_away_pagerank[i] <- 0
  }
}


final_games <- final_games %>%
  mutate(
    last5_home_wins = last5_home_wins,
    last5_away_wins = last5_away_wins,
    last5_home_pointsscored = last5_home_pointsscored,
    last5_home_pointsallowed = last5_home_pointsallowed,
    last5_away_pointsscored = last5_away_pointsscored,
    last5_away_pointsallowed = last5_away_pointsallowed,
    last5_home_incoming_ypp = last5_home_ypp,
    last5_home_incoming_ypp_a = last5_home_ypp_a,
    last5_away_incoming_ypp = last5_away_ypp,
    last5_away_incoming_ypp_a = last5_away_ypp_a,
    last5_home_incoming_ypp_diff = home_ypp - home_incoming_ypp_a,
    last5_away_incoming_ypp_diff = away_ypp - away_incoming_ypp_a,
    last5_ypp_diff_diff = (home_ypp - home_incoming_ypp_a) - (away_ypp - away_incoming_ypp_a),
    last10_wins_home = last10_wins_home,
    last10_wins_away = last10_wins_away,
    last10_home_pagerank = last10_home_pagerank,
    last10_away_pagerank = last10_away_pagerank
  )

```

```{r}
write.csv(final_games, "~/GitHub/Sam_Sp25/final_games.csv", row.names = FALSE)
```


```{r}
get_last5incoming_ypp(season_num=2004, 
                                             week_num=1,
                                             team_name="NE")
```

```{r}
final_games <- read.csv("~/GitHub/Sam_Sp25/final_games.csv", stringsAsFactors=TRUE)
```

```{r}
rescale(c(1,2,3,4,5,6,7,8,9,10)/10, to = c(10, 20), from = c(0,.2))
library("scales")

min(final_games$home_pagerank)
min(final_games$away_pagerank)
```


Ideas:

Incorporate into model from existing data
- pagerank
- weather?
- strength of schedule (interacting?)
- QB or coach change (from week 1?) **
- Current streak **
- Record in previous x games
- head to head record for last x years
- Coming off big win/loss?  **
- Playoff implications
- Long travel **
- new variables for last x games


Find additional data (NFLfastR?)
- yards per play
- passing/rushing yards
- turnovers
- Problems with NFLfastR 
  - missing 1999 week 1 bal stl (and others?)
  - tries to revert to modern names, but weird things seem to happen
    - STL/LA plays itself in 1999 week 4


Actually vs. Vegas
- not just binary, but prob/odds
- compare to moneyline
- see if profitable (only bet strong difference games?)
- what about always bet home/away or fav/dog team?
- look at distributions of models probs vs. vegas probs
- distribution of % return for random guesses
- odds shopping


Computations/visualizations
- plot densities of variables
- randomize picks to compute p-value-ish things
- really limit training data to games prior
- track year by year
- track over course of year
- train also on previous year?
